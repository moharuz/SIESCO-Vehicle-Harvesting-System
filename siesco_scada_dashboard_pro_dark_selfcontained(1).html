<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SIESCO Vehicle Harvesting System ‚Äî SCADA Pro (Dark, Self‚ÄëContained)</title>
<style>
  :root{
    --bg:#0f141a;
    --panel:#151b23;
    --panel-2:#1b2430;
    --text:#e8eef5;
    --muted:#a7b2c3;
    --accent:#00d4ff;
    --good:#3ddc97;
    --warn:#ffd166;
    --bad:#ff6b6b;
    --card:#121821;
    --grid:#2a3442;
    --kpi:#0c1117;
    --shadow: 0 10px 24px rgba(0,0,0,.35);
  }
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body{
    margin:0; background:var(--bg); color:var(--text); font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    gap:16px; padding:16px 20px; background:linear-gradient(180deg, #121721 0%, #0f141a 100%);
    border-bottom:1px solid #1f2a37; position:sticky; top:0; z-index:50;
  }
  .brand{display:flex; align-items:center; gap:14px;}
  .logo{
    width:44px; height:44px; border-radius:12px;
    background: radial-gradient(75% 75% at 30% 30%, #18bfff 0%, #0066ff 60%, #00172e 100%);
    box-shadow: inset 0 0 18px rgba(255,255,255,.15), 0 8px 24px rgba(0,102,255,.25);
    position:relative;
  }
  .logo::after{
    content:""; position:absolute; inset:10px; border-radius:8px;
    background: conic-gradient(from 180deg, rgba(255,255,255,.2), transparent 35%, rgba(255,255,255,.15) 65%, transparent 100%);
    filter: blur(4px);
  }
  h1{margin:0; font-size:20px; letter-spacing:.3px; font-weight:700;}
  .toolbar{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
  .pill{
    background:var(--panel); border:1px solid #223043; border-radius:14px; padding:8px 10px; display:flex; align-items:center; gap:8px;
  }
  .pill input[type="number"]{width:80px;}
  label{color:var(--muted); font-size:13px;}
  input, select{
    background:#0b1016; border:1px solid #223043; color:var(--text);
    padding:6px 8px; border-radius:8px; outline:none;
  }
  input[type="checkbox"]{ width:18px; height:18px; accent-color: var(--accent); }
  main{ padding:18px; }
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px; }
  .tab{
    padding:10px 14px; border-radius:10px; background:var(--panel);
    border:1px solid #223043; cursor:pointer; color:var(--muted);
  }
  .tab.active{ background:#0c1117; color:var(--text); border-color:#345072; }
  .screen{ display:none; }
  .screen.active{ display:block; }
  .grid{
    display:grid; gap:14px;
  }
  /* SCADA layout */
  .scada-layout{
    display:grid; grid-template-columns: 1.2fr 2fr 0.9fr; gap:16px;
  }
  .card{
    background:var(--panel); border:1px solid #223043; border-radius:14px; padding:14px; box-shadow:var(--shadow);
  }
  .card h3{ margin:0 0 10px 0; font-size:14px; color:var(--muted); font-weight:600; letter-spacing:.4px; text-transform:uppercase; }
  .kpi-row{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:14px; margin-bottom:14px;}
  .kpi{
    background:var(--kpi); border:1px solid #223043; border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:10px;
  }
  .kpi .label{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.4px;}
  .kpi .value{ font-size:26px; font-weight:800; letter-spacing:.5px;}
  .kpi.good .value{ color:var(--good); }
  .kpi.bad .value{ color:var(--bad); }
  .kpi .sub{ font-size:12px; color:var(--muted); }
  .ring{
    --size: 64px; width:var(--size); height:var(--size); border-radius:50%;
    background: conic-gradient(var(--good) calc(var(--p,50)*1%), #2b3645 0);
    display:grid; place-items:center; font-weight:700; font-size:14px; color:#eafbf2;
    border:2px solid #243246;
  }
  .flex{ display:flex; gap:12px; align-items:center; }
  .right{ text-align:right; }
  .small{ font-size:12px; color:var(--muted); }
  .flow{
    background:var(--card); border:1px dashed #2a3a52; border-radius:14px; padding:10px;
  }
  .flow svg{ width:100%; height:540px; display:block; }
  .legend{ display:flex; gap:10px; flex-wrap:wrap; }
  .legend .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
  .legend span{ color:var(--muted); font-size:12px; }
  .btn{
    background:#0e1520; border:1px solid #2b3d57; color:var(--text); padding:10px 12px;
    border-radius:10px; cursor:pointer; font-weight:600;
  }
  .btn.on{ border-color:#2a5f43; background:#0d1b15; color:#a7f3d0; }
  .btn.warn{ border-color:#5f3b2a; color:#ffd7ae; }
  .btn:active{ transform: translateY(1px); }
  canvas.chart{ width:100%; height:200px; background:#0b1118; border-radius:12px; border:1px solid #223043; display:block;}
  .mini{ height:60px !important; }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  th, td{ padding:10px 8px; border-bottom:1px solid #223043; }
  th{ text-align:left; color:#b9c6d8; font-weight:700; background:#0f1823; position:sticky; top:0; }
  .money.plus{ color:var(--good); }
  .money.minus{ color:var(--bad); }
  .muted{ color:var(--muted); }
  .center{ text-align:center; }
  .two-col{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  @media (max-width:1100px){
    .kpi-row{ grid-template-columns: 1fr 1fr; }
    .scada-layout{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>SIESCO Vehicle Harvesting System</h1>
      <div class="small">Modern SCADA Dashboard ‚Äî Dark Mode</div>
    </div>
  </div>
  <div class="toolbar">
    <div class="pill">
      <label>Operating hours/day&nbsp;</label><input id="opHours" type="number" min="0" max="24" step="0.5" value="20">
    </div>
    <div class="pill">
      <label>Operating days/year&nbsp;</label><input id="opDays" type="number" min="0" max="366" step="1" value="330">
    </div>
    <div class="pill">
      <label>Grid Import Tariff (SAR/kWh)&nbsp;</label><input id="tariffIn" type="number" min="0" step="0.01" value="0.30">
    </div>
    <div class="pill">
      <label>Grid Export Tariff (SAR/kWh)&nbsp;</label><input id="tariffOut" type="number" min="0" step="0.01" value="0.20">
    </div>
  </div>
</header>

<main>
  <div class="tabs" id="tabs"></div>

  <!-- SCADA SCREEN -->
  <section class="screen active" id="screen-scada">
    <div class="kpi-row">
      <div class="kpi" id="kpiVehicles">
        <div class="label">Vehicles Passed</div>
        <div class="value" id="valVehicles">0</div>
        <div class="sub muted">Cumulative since start</div>
      </div>
      <div class="kpi" id="kpiTotalGen">
        <div class="label">Cumulative Total Generation</div>
        <div class="value" id="valTotalGen">0.000 kWh</div>
        <div class="sub muted">All sources combined</div>
      </div>
      <div class="kpi">
        <div class="label">Battery SOC</div>
        <div class="flex">
          <div class="ring" id="socRing" style="--p:50">50%</div>
          <div class="right">
            <div class="value" id="valSoc">50%</div>
            <div class="sub muted">Capacity 200 kWh, ¬±50 kW</div>
          </div>
        </div>
      </div>
      <div class="kpi" id="kpiFin">
        <div class="label">Financial Balance</div>
        <div class="value" id="valFin">0.00 SAR</div>
        <div class="sub muted">Export ‚àí Import (net)</div>
      </div>
    </div>

    <div class="card">
      <h3>Total Generation (kWh) ‚Äî Cumulative</h3>
      <canvas id="cumGenChart" class="chart" height="220"></canvas>
    </div>

    <div class="scada-layout">
      <div class="card">
        <h3>Controls</h3>
        <div class="flex" style="flex-wrap:wrap;">
          <button class="btn on" id="btnSolar">‚òÄÔ∏è Solar: ON</button>
          <button class="btn on" id="btnWind">üå¨Ô∏è Wind: ON</button>
          <button class="btn on" id="btnDiesel">‚õΩ Diesel: ON</button>
          <button class="btn warn" id="btnReset">üîÑ Reset</button>
        </div>
        <div class="two-col" style="margin-top:12px;">
          <div>
            <label>Target traffic (veh/h)</label>
            <input id="targetTraffic" type="number" min="0" step="10" value="1000">
          </div>
          <div>
            <label>Average Load (kW)</label>
            <input id="avgLoad" type="number" min="0" step="10" value="180">
          </div>
          <div>
            <label>Solar Rated (kW)</label>
            <input id="solarRated" type="number" min="0" step="10" value="120">
          </div>
          <div>
            <label>Wind Rated (kW)</label>
            <input id="windRated" type="number" min="0" step="10" value="80">
          </div>
          <div>
            <label>Diesel Rated (kW)</label>
            <input id="dieselRated" type="number" min="0" step="10" value="150">
          </div>
        </div>
        <p class="small muted" style="margin-top:8px;">
          Vehicles energy per car uses: m=1500 kg, v=30‚Äì50 km/h, KE=¬Ωmv¬≤, √ó2 axles √ó30 units √ó25% per unit ‚Üí kWh.
        </p>
      </div>

      <div class="card flow">
        <h3>SCADA Flow Diagram (kW & SAR/s)</h3>
        <svg id="scadaSvg" viewBox="0 0 1000 540" preserveAspectRatio="xMidYMid meet" aria-label="SCADA flow">
          <!-- Nodes -->
          <defs>
            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <!-- Source Nodes -->
          <g class="node" id="nVehicles">
            <rect x="40" y="40" rx="12" ry="12" width="160" height="70" fill="#0f1a25" stroke="#2f4a6a"/>
            <text x="120" y="70" text-anchor="middle" fill="#e8eef5" font-weight="700">Vehicles</text>
            <text id="tVehicles" x="120" y="92" text-anchor="middle" fill="#a7b2c3" font-size="12">0 kW</text>
          </g>
          <g class="node" id="nSolar">
            <rect x="40" y="140" rx="12" ry="12" width="160" height="70" fill="#0f1a25" stroke="#2f4a6a"/>
            <text x="120" y="170" text-anchor="middle" fill="#e8eef5" font-weight="700">Solar</text>
            <text id="tSolar" x="120" y="192" text-anchor="middle" fill="#a7b2c3" font-size="12">0 kW</text>
          </g>
          <g class="node" id="nWind">
            <rect x="40" y="240" rx="12" ry="12" width="160" height="70" fill="#0f1a25" stroke="#2f4a6a"/>
            <text x="120" y="270" text-anchor="middle" fill="#e8eef5" font-weight="700">Wind</text>
            <text id="tWind" x="120" y="292" text-anchor="middle" fill="#a7b2c3" font-size="12">0 kW</text>
          </g>
          <g class="node" id="nDiesel">
            <rect x="40" y="340" rx="12" ry="12" width="160" height="70" fill="#0f1a25" stroke="#2f4a6a"/>
            <text x="120" y="370" text-anchor="middle" fill="#e8eef5" font-weight="700">Diesel Gen</text>
            <text id="tDiesel" x="120" y="392" text-anchor="middle" fill="#a7b2c3" font-size="12">0 kW</text>
          </g>

          <!-- Inverter -->
          <g class="node" id="nInverter">
            <rect x="430" y="190" rx="12" ry="12" width="140" height="90" fill="#101a26" stroke="#345072"/>
            <text x="500" y="220" text-anchor="middle" fill="#e8eef5" font-weight="700">Inverter</text>
            <text id="tInv" x="500" y="242" text-anchor="middle" fill="#a7b2c3" font-size="12">0 kW</text>
          </g>

          <!-- Sinks -->
          <g class="node" id="nBattery">
            <rect x="800" y="40" rx="12" ry="12" width="160" height="70" fill="#0f1a25" stroke="#2f4a6a"/>
            <text x="880" y="70" text-anchor="middle" fill="#e8eef5" font-weight="700">Battery</text>
            <text id="tBatt" x="880" y="92" text-anchor="middle" fill="#a7b2c3" font-size="12">0 kW</text>
          </g>
          <g class="node" id="nLoad">
            <rect x="800" y="200" rx="12" ry="12" width="160" height="70" fill="#0f1a25" stroke="#2f4a6a"/>
            <text x="880" y="230" text-anchor="middle" fill="#e8eef5" font-weight="700">Load</text>
            <text id="tLoad" x="880" y="252" text-anchor="middle" fill="#a7b2c3" font-size="12">0 kW</text>
          </g>
          <g class="node" id="nGrid">
            <rect x="800" y="360" rx="12" ry="12" width="160" height="70" fill="#0f1a25" stroke="#2f4a6a"/>
            <text x="880" y="390" text-anchor="middle" fill="#e8eef5" font-weight="700">Grid</text>
            <text id="tGrid" x="880" y="412" text-anchor="middle" fill="#a7b2c3" font-size="12">0 kW</text>
          </g>

          <!-- Arrows (paths) -->
          <g stroke-width="3" fill="none" marker-end="url(#arrow)">
            <defs>
              <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#2bd4a3"></path>
              </marker>
              <marker id="arrow-red" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#ff6b6b"></path>
              </marker>
              <marker id="arrow-blue" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#66c2ff"></path>
              </marker>
            </defs>
            <!-- Sources to inverter -->
            <path id="aVehInv" stroke="#2bd4a3" d="M 200 75 C 300 75, 360 215, 430 235"></path>
            <path id="aSolInv" stroke="#2bd4a3" d="M 200 175 C 300 175, 360 215, 430 235"></path>
            <path id="aWinInv" stroke="#2bd4a3" d="M 200 275 C 300 275, 360 235, 430 235"></path>
            <path id="aDieInv" stroke="#2bd4a3" d="M 200 375 C 300 375, 360 255, 430 235"></path>

            <!-- Inverter to sinks -->
            <path id="aInvBatt" stroke="#66c2ff" d="M 570 235 C 660 150, 730 85, 800 75" marker-end="url(#arrow-blue)"></path>
            <path id="aInvLoad" stroke="#ffb703" d="M 570 235 C 650 235, 730 235, 800 235" marker-end="url(#arrow)"></path>
            <path id="aInvGrid" stroke="#ff6b6b" d="M 570 235 C 660 330, 730 395, 800 395" marker-end="url(#arrow-red)"></path>
          </g>

          <!-- Flow labels -->
          <text id="labVehInv" x="320" y="95" fill="#9ee8d1" font-size="12">0 kW</text>
          <text id="labSolInv" x="320" y="160" fill="#9ee8d1" font-size="12">0 kW</text>
          <text id="labWinInv" x="320" y="260" fill="#9ee8d1" font-size="12">0 kW</text>
          <text id="labDieInv" x="320" y="335" fill="#9ee8d1" font-size="12">0 kW</text>

          <text id="labInvBatt" x="690" y="120" fill="#a6d9ff" font-size="12">0 kW (SAR/s)</text>
          <text id="labInvLoad" x="690" y="255" fill="#ffe099" font-size="12">0 kW (SAR/s)</text>
          <text id="labInvGrid" x="690" y="370" fill="#ffb3b3" font-size="12">0 kW (SAR/s)</text>
        </svg>
        <div class="legend">
          <span><i class="dot" style="background:#2bd4a3"></i> Generation</span>
          <span><i class="dot" style="background:#66c2ff"></i> Battery Flow</span>
          <span><i class="dot" style="background:#ff6b6b"></i> Grid Export</span>
          <span><i class="dot" style="background:#ffb703"></i> Load</span>
        </div>
      </div>

      <div class="card">
        <h3>Live Values</h3>
        <table>
          <tbody>
            <tr><td>Vehicles power</td><td id="tblVeh">0 kW</td></tr>
            <tr><td>Solar power</td><td id="tblSol">0 kW</td></tr>
            <tr><td>Wind power</td><td id="tblWin">0 kW</td></tr>
            <tr><td>Diesel power</td><td id="tblDie">0 kW</td></tr>
            <tr><td>Battery flow (chg + / dis ‚àí)</td><td id="tblBat">0 kW</td></tr>
            <tr><td>Load</td><td id="tblLoad">0 kW</td></tr>
            <tr><td>Grid (imp + / exp ‚àí)</td><td id="tblGrid">0 kW</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Performance Summary -->
  <section class="screen" id="screen-summary">
    <div class="card">
      <h3>Performance Summary</h3>
      <table id="perfTable">
        <thead>
          <tr>
            <th>Period</th>
            <th>Energy ‚Äî Vehicles (kWh)</th>
            <th>Solar (kWh)</th>
            <th>Wind (kWh)</th>
            <th>Diesel (kWh)</th>
            <th>Total Generation (kWh)</th>
            <th>Load (kWh)</th>
            <th>Grid Import (kWh)</th>
            <th>Grid Export (kWh)</th>
            <th>Value (SAR)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="two-col">
      <div class="card">
        <h3>Generation Sparkline</h3>
        <canvas id="sparkGen" class="chart mini" height="70"></canvas>
      </div>
      <div class="card">
        <h3>Financial Sparkline</h3>
        <canvas id="sparkFin" class="chart mini" height="70"></canvas>
      </div>
    </div>
  </section>

  <!-- System Tabs (placeholders with small charts) -->
  <section class="screen" id="screen-vehicles">
    <div class="card"><h3>Vehicles ‚Äî Power (kW)</h3><canvas id="chartVeh" class="chart" height="220"></canvas></div>
  </section>
  <section class="screen" id="screen-solar">
    <div class="card"><h3>Solar ‚Äî Power (kW)</h3><canvas id="chartSol" class="chart" height="220"></canvas></div>
  </section>
  <section class="screen" id="screen-wind">
    <div class="card"><h3>Wind ‚Äî Power (kW)</h3><canvas id="chartWin" class="chart" height="220"></canvas></div>
  </section>
  <section class="screen" id="screen-diesel">
    <div class="card"><h3>Diesel ‚Äî Power (kW)</h3><canvas id="chartDie" class="chart" height="220"></canvas></div>
  </section>
  <section class="screen" id="screen-battery">
    <div class="card"><h3>Battery ‚Äî Power Flow (kW)</h3><canvas id="chartBat" class="chart" height="220"></canvas></div>
  </section>
  <section class="screen" id="screen-grid">
    <div class="card"><h3>Grid ‚Äî Import(+)/Export(‚àí) (kW)</h3><canvas id="chartGrid" class="chart" height="220"></canvas></div>
  </section>
  <section class="screen" id="screen-load">
    <div class="card"><h3>Load ‚Äî Power (kW)</h3><canvas id="chartLoad" class="chart" height="220"></canvas></div>
  </section>
  <section class="screen" id="screen-financials">
    <div class="card"><h3>Financials ‚Äî SAR per second</h3><canvas id="chartFin" class="chart" height="220"></canvas></div>
  </section>
</main>

<script>
/* ---------- Simple stateful line chart (Canvas, no deps) ---------- */
class LineChart {
  constructor(canvas, opts={}){
    this.c = canvas;
    this.ctx = canvas.getContext('2d');
    this.data = [];
    this.maxPoints = opts.maxPoints || 1200; // ~20 min at 1s
    this.color = opts.color || '#00d4ff';
    this.grid = opts.grid !== false;
  }
  push(v){
    this.data.push(v);
    if (this.data.length > this.maxPoints) this.data.shift();
    this.draw();
  }
  setData(arr){
    this.data = arr.slice(-this.maxPoints);
    this.draw();
  }
  clear(){
    this.data = [];
    this.draw();
  }
  draw(){
    const {width, height} = this.c.getBoundingClientRect();
    if (this.c.width !== width) this.c.width = width;
    if (this.c.height !== height) this.c.height = height;
    const ctx = this.ctx, w = this.c.width, h = this.c.height;
    ctx.clearRect(0,0,w,h);
    // grid
    if (this.grid){
      ctx.strokeStyle = '#1e2a39'; ctx.lineWidth = 1;
      for(let x=0;x<w;x+=Math.max(40, w/12)){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
      for(let y=0;y<h;y+=Math.max(30, h/8)){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
    }
    if (!this.data.length) return;
    const max = Math.max(...this.data, 1);
    const min = Math.min(...this.data, 0);
    const pad = 8;
    const scale = (v)=> h - pad - ( (v-min) / (max-min || 1) )*(h-2*pad);
    ctx.strokeStyle = this.color; ctx.lineWidth = 2.2;
    ctx.beginPath();
    this.data.forEach((v,i)=>{
      const x = (i/(this.data.length-1 || 1))*(w-2*pad) + pad;
      const y = scale(v);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    // y labels
    ctx.fillStyle = '#a7b2c3'; ctx.font = '12px system-ui';
    ctx.fillText(max.toFixed(1), 6, 14);
    ctx.fillText(min.toFixed(1), 6, h-6);
  }
}

/* ---------- Tabs ---------- */
const tabs = [
  {id:'scada', label:'SCADA'},
  {id:'summary', label:'Performance Summary'},
  {id:'vehicles', label:'Vehicles'},
  {id:'solar', label:'Solar'},
  {id:'wind', label:'Wind'},
  {id:'diesel', label:'Diesel'},
  {id:'battery', label:'Battery'},
  {id:'grid', label:'Grid'},
  {id:'load', label:'Consumption'},
  {id:'financials', label:'Financials'}
];
const tabsEl = document.getElementById('tabs');
tabs.forEach(t=>{
  const b = document.createElement('button');
  b.className='tab'+(t.id==='scada'?' active':'');
  b.textContent = t.label;
  b.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById('screen-'+t.id).classList.add('active');
  };
  tabsEl.appendChild(b);
});

/* ---------- Simulation state ---------- */
const state = {
  t: 0,
  vehiclesPassed: 0,
  cumGenKWh: 0,
  finBalance: 0,
  // live powers (kW)
  vehKW: 0, solKW: 0, winKW: 0, dieKW: 0,
  invToBattKW: 0, invToLoadKW: 0, invToGridKW: 0,
  battFlowKW: 0, gridKW: 0, loadKW: 180,
  // battery
  battCapKWh: 200, battSOC: 0.5, battMaxRateKW: 50,
  // toggles
  solarOn: true, windOn: true, dieselOn: true,
  // tariffs (SAR/kWh)
  importTariff: 0.30, exportTariff: 0.20,
  // settings
  targetTraffic: 1000, avgLoadKW: 180,
  // accumulators for summary (kWh)
  acc: {
    veh:0, sol:0, win:0, die:0, gen:0, load:0, gridIn:0, gridOut:0
  },
  // arrays for charts
  seq: {
    cumGen: [], fin: [],
    veh:[], sol:[], win:[], die:[], batt:[], grid:[], load:[]
  }
};

// DOM bindings
const el = {
  vehicles: document.getElementById('valVehicles'),
  totalGen: document.getElementById('valTotalGen'),
  fin: document.getElementById('valFin'),
  soc: document.getElementById('valSoc'),
  socRing: document.getElementById('socRing'),
  // SCADA labels
  tVehicles: document.getElementById('tVehicles'),
  tSolar: document.getElementById('tSolar'),
  tWind: document.getElementById('tWind'),
  tDiesel: document.getElementById('tDiesel'),
  tInv: document.getElementById('tInv'),
  tBatt: document.getElementById('tBatt'),
  tLoad: document.getElementById('tLoad'),
  tGrid: document.getElementById('tGrid'),
  labVehInv: document.getElementById('labVehInv'),
  labSolInv: document.getElementById('labSolInv'),
  labWinInv: document.getElementById('labWinInv'),
  labDieInv: document.getElementById('labDieInv'),
  labInvBatt: document.getElementById('labInvBatt'),
  labInvLoad: document.getElementById('labInvLoad'),
  labInvGrid: document.getElementById('labInvGrid'),
  // table
  tblVeh: document.getElementById('tblVeh'),
  tblSol: document.getElementById('tblSol'),
  tblWin: document.getElementById('tblWin'),
  tblDie: document.getElementById('tblDie'),
  tblBat: document.getElementById('tblBat'),
  tblLoad: document.getElementById('tblLoad'),
  tblGrid: document.getElementById('tblGrid'),
};

// Controls
document.getElementById('btnSolar').onclick = (e)=>{
  state.solarOn = !state.solarOn;
  e.target.classList.toggle('on', state.solarOn);
  e.target.textContent = (state.solarOn?'‚òÄÔ∏è Solar: ON':'‚òÄÔ∏è Solar: OFF');
};
document.getElementById('btnWind').onclick = (e)=>{
  state.windOn = !state.windOn;
  e.target.classList.toggle('on', state.windOn);
  e.target.textContent = (state.windOn?'üå¨Ô∏è Wind: ON':'üå¨Ô∏è Wind: OFF');
};
document.getElementById('btnDiesel').onclick = (e)=>{
  state.dieselOn = !state.dieselOn;
  e.target.classList.toggle('on', state.dieselOn);
  e.target.textContent = (state.dieselOn?'‚õΩ Diesel: ON':'‚õΩ Diesel: OFF');
};
document.getElementById('btnReset').onclick = ()=>{
  state.t = 0; state.vehiclesPassed=0; state.cumGenKWh=0; state.finBalance=0;
  for (let k in state.acc) state.acc[k]=0;
  for (let k in state.seq) state.seq[k]=[];
  charts.cumGen.clear(); charts.fin.clear();
  charts.veh.clear(); charts.sol.clear(); charts.win.clear(); charts.die.clear();
  charts.batt.clear(); charts.grid.clear(); charts.load.clear();
  renderSummaryTable();
};

// Inputs
document.getElementById('opHours').oninput = (e)=> opHours = +e.target.value || 0;
document.getElementById('opDays').oninput = (e)=> opDays = +e.target.value || 0;
document.getElementById('tariffIn').oninput = (e)=> state.importTariff = +e.target.value || 0;
document.getElementById('tariffOut').oninput = (e)=> state.exportTariff = +e.target.value || 0;
document.getElementById('targetTraffic').oninput = (e)=> state.targetTraffic = +e.target.value || 0;
document.getElementById('avgLoad').oninput = (e)=> state.avgLoadKW = +e.target.value || 0;
document.getElementById('solarRated').oninput = (e)=> solarRated = +e.target.value || 0;
document.getElementById('windRated').oninput = (e)=> windRated = +e.target.value || 0;
document.getElementById('dieselRated').oninput = (e)=> dieselRated = +e.target.value || 0;

// Globals derived from inputs
let opHours = +document.getElementById('opHours').value;
let opDays  = +document.getElementById('opDays').value;
let solarRated = +document.getElementById('solarRated').value;
let windRated = +document.getElementById('windRated').value;
let dieselRated = +document.getElementById('dieselRated').value;

/* ---------- Charts ---------- */
const charts = {
  cumGen: new LineChart(document.getElementById('cumGenChart'), {maxPoints: 36000, color:'#00d4ff'}), // 10 hours @ 1s
  fin: new LineChart(document.getElementById('chartFin'), {maxPoints: 36000, color:'#3ddc97'}),
  veh: new LineChart(document.getElementById('chartVeh'), {color:'#ffd166'}),
  sol: new LineChart(document.getElementById('chartSol'), {color:'#ffe566'}),
  win: new LineChart(document.getElementById('chartWin'), {color:'#66c2ff'}),
  die: new LineChart(document.getElementById('chartDie'), {color:'#ff9f66'}),
  batt:new LineChart(document.getElementById('chartBat'), {color:'#a0e9ff'}),
  grid:new LineChart(document.getElementById('chartGrid'), {color:'#ff6b6b'}),
  load:new LineChart(document.getElementById('chartLoad'), {color:'#caffbf'}),
  sparkGen: new LineChart(document.getElementById('sparkGen'), {maxPoints:300, color:'#ffe566'}),
  sparkFin: new LineChart(document.getElementById('sparkFin'), {maxPoints:300, color:'#3ddc97'})
};

/* ---------- Helpers ---------- */
function rand(min,max){ return Math.random()*(max-min)+min; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function fmtKW(v){ return (v>=0? v : -v).toFixed(1) + ' kW' + (v<0?' (‚àí)':''); }
function fmtKWh(v){ return (v).toFixed(3)+' kWh'; }
function fmtSAR(v){ const s = v>=0? v : -v; return (v>=0? '+':'‚àí') + s.toFixed(2)+' SAR'; }

// Poisson random for lambda <= 1 (Knuth)
function randPoisson(lambda){
  const L = Math.exp(-lambda);
  let k = 0, p = 1;
  do { k++; p *= Math.random(); } while (p > L);
  return k - 1;
}

// Vehicles energy per car in kWh
function energyPerVehicleKWh(){
  const m = 1500; // kg
  const vkmh = rand(30,50);
  const v = vkmh * (1000/3600); // m/s
  const KE = 0.5*m*v*v; // J
  const J = KE * 2 * 30 * 0.25; // *2 axles *30 units *25%
  return J / 3.6e6; // kWh
}

/* ---------- Simulation loop (1 Hz) ---------- */
function step(){
  state.t++;

  // Vehicles per second: targetTraffic per hour -> lambda per second
  const lambda = state.targetTraffic / 3600;
  const cars = randPoisson(lambda);
  state.vehiclesPassed += cars;

  // Energy from vehicles this second
  let vehKWh = 0;
  for (let i=0;i<cars;i++) vehKWh += energyPerVehicleKWh();
  state.vehKW = vehKWh * 3600; // kW instantaneous (per second energy * 3600)

  // Solar / Wind profiles (if enabled)
  const hourDay = ( (new Date()).getHours() + (new Date()).getMinutes()/60 );
  const dayFactor = Math.max(0, Math.sin(Math.PI * (hourDay-6)/12)); // peak at ~12:00
  state.solKW = state.solarOn ? solarRated * dayFactor * (0.75 + 0.25*Math.random()) : 0;
  state.winKW = state.windOn ? windRated * (0.4 + 0.6*Math.random()) : 0;

  // Load varies around avg
  state.loadKW = Math.max(10, state.avgLoadKW * (0.85 + 0.3*Math.random()));

  // Available generation before diesel
  let genKW = state.vehKW + state.solKW + state.winKW;

  // Diesel kicks in to cover deficit if on
  let deficit = state.loadKW - genKW;
  if (deficit > 0 && state.dieselOn){
    const need = Math.min(deficit, dieselRated);
    state.dieKW = need;
    genKW += need;
  } else {
    state.dieKW = 0;
  }

  // Battery interaction
  // If gen > load ‚Üí charge (up to max rate); If gen < load ‚Üí discharge (down to min SOC and max rate)
  let net = genKW - state.loadKW; // + surplus
  let battRoomKWh = (1.0 - state.battSOC) * state.battCapKWh;
  let battEnergyThisSec = 0; // kWh (+ charge, ‚àí discharge)

  if (net > 0){
    // charge
    const maxChargeKWh = (state.battMaxRateKW/3600);
    const chargeKWh = Math.min(net/3600, maxChargeKWh, battRoomKWh);
    battEnergyThisSec = chargeKWh;
    state.battSOC = clamp(state.battSOC + chargeKWh / state.battCapKWh, 0.10, 1.00);
    state.invToBattKW = chargeKWh*3600;
    net -= state.invToBattKW; // remaining surplus
  } else if (net < 0){
    // discharge
    const availableKWh = Math.max(0, (state.battSOC-0.10)*state.battCapKWh);
    const maxDisKWh = (state.battMaxRateKW/3600);
    const dischargeKWh = Math.min((-net)/3600, maxDisKWh, availableKWh);
    battEnergyThisSec = -dischargeKWh;
    state.battSOC = clamp(state.battSOC - dischargeKWh / state.battCapKWh, 0.10, 1.00);
    state.invToBattKW = -dischargeKWh*3600; // negative to indicate discharge
    net += dischargeKWh*3600; // reduce deficit
  } else {
    state.invToBattKW = 0;
  }

  // Remaining net goes to grid: positive = export, negative = import
  state.invToGridKW = net;
  state.gridKW = net; // display sign convention: + import? We'll show import positive in table, but text shows sign
  state.invToLoadKW = state.loadKW;

  // Accumulate energies (kWh) for summary
  const secToKWh = (x)=> x/3600;
  const vehKWhSec = secToKWh(state.vehKW);
  const solKWhSec = secToKWh(state.solKW);
  const winKWhSec = secToKWh(state.winKW);
  const dieKWhSec = secToKWh(state.dieKW);
  const loadKWhSec= secToKWh(state.loadKW);
  const gridKWhSec= secToKWh(state.invToGridKW); // + export, ‚àí import

  state.acc.veh += vehKWhSec;
  state.acc.sol += solKWhSec;
  state.acc.win += winKWhSec;
  state.acc.die += dieKWhSec;
  state.acc.gen += vehKWhSec + solKWhSec + winKWhSec + dieKWhSec;
  state.acc.load += loadKWhSec;
  if (gridKWhSec >= 0) state.acc.gridOut += gridKWhSec; else state.acc.gridIn += -gridKWhSec;

  // Financials per second
  const sarExport = Math.max(0, gridKWhSec) * state.exportTariff;
  const sarImport = Math.max(0, -gridKWhSec) * state.importTariff;
  state.finBalance += (sarExport - sarImport);

  // Cumulative generation
  state.cumGenKWh += vehKWhSec + solKWhSec + winKWhSec + dieKWhSec;

  // Update charts
  charts.cumGen.push(state.cumGenKWh);
  charts.fin.push(state.finBalance);
  charts.veh.push(state.vehKW);
  charts.sol.push(state.solKW);
  charts.win.push(state.winKW);
  charts.die.push(state.dieKW);
  charts.batt.push(state.invToBattKW);
  charts.grid.push(state.invToGridKW);
  charts.load.push(state.loadKW);
  charts.sparkGen.push(vehKWhSec + solKWhSec + winKWhSec + dieKWhSec);
  charts.sparkFin.push(state.finBalance);

  // KPIs
  el.vehicles.textContent = state.vehiclesPassed.toLocaleString();
  el.totalGen.textContent = fmtKWh(state.cumGenKWh);
  el.fin.textContent = (state.finBalance>=0? '+':'‚àí') + Math.abs(state.finBalance).toFixed(2) + ' SAR';
  document.getElementById('kpiFin').classList.toggle('good', state.finBalance>=0);
  document.getElementById('kpiFin').classList.toggle('bad', state.finBalance<0);

  const socPct = Math.round(state.battSOC*100);
  el.soc.textContent = socPct + '%';
  el.socRing.style.setProperty('--p', socPct);
  el.socRing.textContent = socPct + '%';

  // SCADA labels
  el.tVehicles.textContent = state.vehKW.toFixed(1)+' kW';
  el.tSolar.textContent = state.solKW.toFixed(1)+' kW';
  el.tWind.textContent = state.winKW.toFixed(1)+' kW';
  el.tDiesel.textContent = state.dieKW.toFixed(1)+' kW';
  el.tInv.textContent = (state.vehKW+state.solKW+state.winKW+state.dieKW).toFixed(1)+' kW';

  el.tBatt.textContent = (state.invToBattKW>=0? '+' : '‚àí') + Math.abs(state.invToBattKW).toFixed(1) + ' kW';
  el.tLoad.textContent = state.invToLoadKW.toFixed(1)+' kW';
  el.tGrid.textContent = (state.invToGridKW>=0? 'Export ' : 'Import ') + Math.abs(state.invToGridKW).toFixed(1)+' kW';

  // Flow labels with SAR/s
  const sarPerSec = (kWhPerSec, tariff)=> kWhPerSec * tariff;
  const gridKWh = state.invToGridKW/3600;
  const sarGrid = gridKWh>=0 ? sarPerSec(gridKWh, state.exportTariff) : -sarPerSec(-gridKWh, state.importTariff);

  document.getElementById('labVehInv').textContent = state.vehKW.toFixed(1)+' kW';
  document.getElementById('labSolInv').textContent = state.solKW.toFixed(1)+' kW';
  document.getElementById('labWinInv').textContent = state.winKW.toFixed(1)+' kW';
  document.getElementById('labDieInv').textContent = state.dieKW.toFixed(1)+' kW';
  document.getElementById('labInvBatt').textContent = (state.invToBattKW>=0? '+' : '‚àí') + Math.abs(state.invToBattKW).toFixed(1)+' kW ('+ (state.invToBattKW/3600*state.importTariff).toFixed(3)+' SAR/s)';
  document.getElementById('labInvLoad').textContent = state.invToLoadKW.toFixed(1)+' kW ('+ (state.invToLoadKW/3600*state.importTariff).toFixed(3)+' SAR/s)';
  document.getElementById('labInvGrid').textContent = (state.invToGridKW>=0? 'Export ' : 'Import ') + Math.abs(state.invToGridKW).toFixed(1)+' kW ('+ sarGrid.toFixed(3) +' SAR/s)';

  // Live values table
  el.tblVeh.textContent = state.vehKW.toFixed(1)+' kW';
  el.tblSol.textContent = state.solKW.toFixed(1)+' kW';
  el.tblWin.textContent = state.winKW.toFixed(1)+' kW';
  el.tblDie.textContent = state.dieKW.toFixed(1)+' kW';
  el.tblBat.textContent = (state.invToBattKW>=0? '+' : '‚àí') + Math.abs(state.invToBattKW).toFixed(1)+' kW';
  el.tblLoad.textContent = state.loadKW.toFixed(1)+' kW';
  el.tblGrid.textContent = (state.invToGridKW>=0? 'Export ' : 'Import ') + Math.abs(state.invToGridKW).toFixed(1)+' kW';

  if (state.t % 10 === 0) renderSummaryTable(); // update every 10s
}

function renderSummaryTable(){
  const tbody = document.querySelector('#perfTable tbody');
  tbody.innerHTML = '';
  const tariffIn = state.importTariff, tariffOut = state.exportTariff;

  // Helper to compute period projections based on last hour average if needed
  const periods = [
    {label:'Last Hour (actual/proj)', hrs:1},
    {label:'Day', hrs: opHours},
    {label:'Week', hrs: opHours*7},
    {label:'Month (30d)', hrs: opHours*30},
    {label:'Year', hrs: opHours*opDays},
    {label:'Total (runtime)', hrs: state.t/3600}
  ];

  // Average rates (kWh/h) based on accumulators since start
  const runtimeH = Math.max(1/3600, state.t/3600);
  const rate = {
    veh: state.acc.veh / runtimeH,
    sol: state.acc.sol / runtimeH,
    win: state.acc.win / runtimeH,
    die: state.acc.die / runtimeH,
    gen: state.acc.gen / runtimeH,
    load: state.acc.load / runtimeH,
    gridIn: state.acc.gridIn / runtimeH,
    gridOut: state.acc.gridOut / runtimeH,
    val: state.finBalance / runtimeH
  };

  periods.forEach(p=>{
    const veh = rate.veh * p.hrs;
    const sol = rate.sol * p.hrs;
    const win = rate.win * p.hrs;
    const die = rate.die * p.hrs;
    const gen = veh+sol+win+die;
    const load= rate.load * p.hrs;
    const gi  = rate.gridIn * p.hrs;
    const go  = rate.gridOut* p.hrs;
    const val = rate.val * p.hrs;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.label}</td>
      <td>${veh.toFixed(2)}</td>
      <td>${sol.toFixed(2)}</td>
      <td>${win.toFixed(2)}</td>
      <td>${die.toFixed(2)}</td>
      <td>${gen.toFixed(2)}</td>
      <td>${load.toFixed(2)}</td>
      <td>${gi.toFixed(2)}</td>
      <td>${go.toFixed(2)}</td>
      <td class="${val>=0?'money plus':'money minus'}">${val>=0?'+':'‚àí'}${Math.abs(val).toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- Boot ---------- */
// init charts once layout ready
const onResize = ()=> { for (const k in charts) charts[k].draw(); };
window.addEventListener('resize', onResize);
onResize();

// start loop (auto-run)
renderSummaryTable();
setInterval(step, 1000);
</script>
</body>
</html>
